name: push-image

on:
  push:
    # The following jobs will be triggered when new tag is pushed
    tags:
      # https://tinyurl.com/48z78htf
      # https://tinyurl.com/2kvbv2hb
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  DOCKER_REGISTRY: ghcr.io

jobs:
  build-and-publish-image:
    runs-on: ubuntu-20.04
    # Adjust GITHUB_TOKEN permissions.
    #
    # Ref: https://tinyurl.com/28y2n32v
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v3
        env:
          IMAGE_NAME: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/iottalk-mosquitto
        with:
          images: ${{ env.IMAGE_NAME }}
          # The character v at the start of git tag will be ignored, only the
          # version numbers will be extracted.
          #
          # Ref: https://github.com/marketplace/actions/docker-metadata-action#typesemver
          tags: |
            type=semver,pattern={{version}}
      - name: Docker Login
        uses: docker/login-action@v1.9.0
        with:
          # The repository where this workflow is stored must have the access to the
          # target GitHub Packages.
          #
          # Ref: https://tinyurl.com/32e52hsn
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          push: true
          # Tags are generated by the previouse step which is named as meta.
          tags: ${{ steps.meta.outputs.tags }}
